<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <title>Project 1</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <script src="https://d3js.org/d3-geo-projection.v3.min.js"></script>

  <style>

  .outlineCount{
      stroke: white;
      stroke-width: .5px;
      fill:none;
    }
    div.projtitle {
      width: 100%;
      height: 50px;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: darkgrey;

    }

    text.projtitle {
      font-family:sans-serif;
      color: white;
    }

    .active {
        fill: #46b6b6;
    }

  </style>


</head>
<body>
  <div class = "projtitle"> <text class = "projtitle"> Visualizing Maternal Mortality </text> </div>


  <svg id="choropleth" height="620" width="800" style="margin:20px" />
  <svg id="graph" height="500" width="800" >
  </svg>
  <div id="button-bar"></div>
  <script>



  const requestData = async () => {

    const unicefData = await d3.csv("unicef_data.csv");
    const countryData = await d3.json("countries-110m.json");
    const incomeData = await d3.csv("incomegroups.csv")
    console.log(unicefData);
    console.log(countryData);
    console.log(incomeData)

    var unicefCountries = []
    for (i = 0; i < unicefData.length; i++) {
      let country = unicefData[i]["GeographicArea"]
      var n = country.indexOf(":")
      country = country.slice(n+2)
      unicefData[i]["GeographicArea"] = country

      if(unicefCountries.includes(country) === false){
        unicefCountries.push(country)
      }
        }

    console.log(unicefCountries);
    console.log(unicefData)
    var low = {}
    var lowmid = {}
    var upmid = {}
    var high = {}
    // Add income level to unicef countries data
    for (i = 0; i < unicefData.length; i++) {
          let country = unicefData[i]["GeographicArea"]
          row = incomeData.filter( (d) => {return d['Economy'] == country;}  )
          row = row[0]
          if (row != undefined){
            income = row['Income group']
            region = row['Region']
            unicefData[i]["IncomeGroup"] = income
            unicefData[i]["Region"] = region}
            }

    console.log(unicefCountries);
    console.log(unicefData)
    console.log(low)

    // console.log(countryData.objects.countries.geometries.length)
    // for (i = 0; i < countryData.objects.countries.geometries.length; i++) {
    //   country = countryData.objects.countries.geometries[i].properties.name
    // //  console.log(country)
    //   if(unicefCountries.includes(country)) {
    //     console.log(country)
    //   }
    // //  console.log(countryData.objects.countries.geometries[i].properties.name)
    //     }

//ADD data to topojson file:
    data = unicefData.filter( (d) => {return d['TimePeriod'] === "2017";}  );
    console.log("data")
    console.log(data)
    var mortvals = {}
    for (i = 0; i < countryData.objects.countries.geometries.length; i++) {
      country = countryData.objects.countries.geometries[i].properties.name
      if (unicefCountries.includes(country)){

        filtered_data = data.filter( (d) => {return d['GeographicArea'] == country;}  )
        var TimePeriod = filtered_data["TimePeriod"]
        var maternal_mortality_ratio = filtered_data[0]["maternal_mortality_ratio"]
        countryData.objects.countries.geometries[i].properties.maternal_mortality_ratio = maternal_mortality_ratio

        mortvals[country] = maternal_mortality_ratio

      }


    }
    console.log(lowmid)

    console.log(countryData)
    var mortvalsorig = mortvals

//Build bar chart:

    const svg = d3.select("#graph");
    const width = svg.attr("width");
    const height = svg.attr("height");

    const margin = {top: 10, right: 10, bottom: 50, left: 50};
    const chartWidth = width - margin.left - margin.right;
    const chartHeight = height - margin.top - margin.bottom;

    let annotations = svg.append("g").attr("id","annotations");
    let chartArea = svg.append("g").attr("id","points")
                        .attr("transform",`translate(${margin.left},${margin.top})`);

    //maxRatio:
    // let maxRatio = d3.max(data, (d) => { return d["maternal_mortality_ratio"]; });
    // let ratios = []
    // for (i = 0; i < data.length; i++) {
    //   ratio = parseInt(data[i]["maternal_mortality_ratio"])
    //
    //   ratios.push(ratio)
    // }
    // console.log(ratios)

    // Only show top 10 bars:
    function getTop10(data){
      let top_ratios = []
      let top_countries = []
      for(i = 0; i < 10; i ++){
        let maxiRatio = 0;
        let topiCountry = "na"
        for (j = 0; j < data.length; j ++){
          ratio = parseInt(data[j]["maternal_mortality_ratio"])
          country = data[j]["GeographicArea"]
          if ((ratio > maxiRatio) & (top_countries.includes(country) == false)) {maxiRatio = ratio; topiCountry = country;}
        }
        top_ratios.push(maxiRatio)
        top_countries.push(topiCountry)
      }
      return({"topratios": top_ratios, "topcountries": top_countries})



    }

    function getTop10Data(data){
      let top10data = getTop10(data)
      let countries = top10data["topcountries"]
      top10data = data.filter((d) => {return countries.includes(d['GeographicArea'])})
      return(top10data)

    }


    let maxRatio = getTop10(data)["topratios"][0]
    var countries = getTop10(data)["topcountries"]
    var top10data = getTop10Data(data);


    const ratioScale = d3.scaleLinear()
                          .domain([0, maxRatio])
                          .range([chartHeight, 0]);

  //  var countries =  d3.map(data, d => d.GeographicArea)

    const countryScale = d3.scaleBand().domain(countries)
                                      .range([0, chartWidth])
                                      .padding(0.05);

    let leftAxis = d3.axisLeft(ratioScale);
                          //.tickFormat(d3.format('.0%'));
    let leftGridlines = d3.axisLeft(ratioScale)
                          .tickSize(-chartWidth-10)
                          .tickFormat("");

    annotations.append("g")
                .attr("class", "y axis")
                .attr("transform",`translate(${margin.left-10},${margin.top})`)
                .call(leftAxis)
    annotations.append("g")
               .attr("class", "y gridlines")
               .attr("transform",`translate(${margin.left-10},${margin.top})`)
               .call(leftGridlines);

    // let bottomAxis = d3.axisBottom(countryScale);
    // annotations.append("g")
    //           .attr("class", "x axis")
    //           .attr("transform",`translate(${margin.left},${chartHeight+margin.top+10})`)
    //           .call(bottomAxis);
    let bottomAxis = d3.axisBottom()
    let bottomAxisG = annotations.append("g")
                                  .attr("class", "x axis")
                                  .attr("transform", `translate(${margin.left},${chartHeight+margin.top+10})`)

    // chartArea.selectAll('rect.bar').data( data )
    //         .join('rect').attr('class','bar')
    //         .attr("fill", "steelblue")
    //         .attr("x", d => countryScale(d.GeographicArea))
    //         .attr("y", d => ratioScale(d.maternal_mortality_ratio))
    //         .attr("height", d => ratioScale(0) - ratioScale(d.maternal_mortality_ratio))
    //         .attr("width", countryScale.bandwidth());

    const allIncomes = ["Low income", "Lower middle income", "Upper middle income", "High income", "All Countries"]
    allIncomes.forEach(d => {
      d3.select("div#button-bar")
        .append("button")
        .text(d)
        .on("click", function(){
          //Update
          updateBars(d);
        })
    })
    function updateBars(incomeKey) {
      if (incomeKey == "All Countries"){
        var updatedData = data
      }
      else {
        var updatedData = data.filter((d) => {return d['IncomeGroup'] === incomeKey})
      }
      top10Data = getTop10Data(updatedData)

      var countries = getTop10(updatedData)["topcountries"]
      const countryScale = d3.scaleBand().domain(countries)
                                        .range([0, chartWidth])
                                        .padding(0.05);
      bottomAxis.scale(countryScale)
      bottomAxisG.call(bottomAxis);

      chartArea.selectAll('rect.bar').data( top10Data )
              .join('rect').attr('class','bar')
              .attr("fill", '#6592bf')
              .attr("x", d => countryScale(d.GeographicArea))
              .attr("y", d => ratioScale(d.maternal_mortality_ratio))
              .attr("height", d => ratioScale(0) - ratioScale(d.maternal_mortality_ratio))
              .attr("width", countryScale.bandwidth())
              .attr("country", d => d["GeographicArea"]);

  };

  updateBars("All Countries");

    //make the map

      const svgc = d3.select("#choropleth");
      const widthm = svgc.attr("width");
      const heightm = svgc.attr("height");
      const marginm = { top: 20, right: 20, bottom: 20, left:20};
      const mapWidth = widthm - marginm.left - marginm.right;
      const mapHeight = heightm - marginm.top - marginm.bottom;
      const map = svgc.append("g")
                      .attr("transform","translate("+marginm.left+","+marginm.top+")");
      countries = topojson.feature(countryData, countryData.objects.countries);
      countryMesh = topojson.mesh(countryData, countryData.objects.countries);



      allIncomes.forEach(d => {
        d3.select("div#button")
          .append("button")
          .text(d)
          .on("click", function(){
            //Update
            updatemap(d);
          })
      })




      var projection =  d3.geoPatterson()
                          .fitSize([mapWidth, mapHeight],countries);

      var path = d3.geoPath().projection(projection);




      console.log(mortvals)

      const colorScale = d3.scaleQuantile()
                              .domain(Object.values(mortvals))
                              .range(['#dfdfc1', '#8bbdcc', '#6592bf', '#3f69af','#00429d' ]);

      console.log()

      d3.json("https://unpkg.com/world-atlas@1/world/110m.json")
        .then(data => {
          map.selectAll("path.countries").data(countries.features)
                                              .join("path")
                                              .attr("class", "country")
                                              .attr("note", d=>d.id)
                                              .attr("d", path)
                                              .on("click", clicked)
                                              .style("fill", d=>colorScale(mortvals[d.properties.name]))
        map.append("path").datum(countryMesh)
                  .attr("class", "outlineCount")
                  .attr("d", path);
        });


        //HELP this is what each country will do when clicked upon- it currently turns the whole freaking map blue so that sucks
        function clicked(d) {
          map.selectAll("path")
            .style("fill", "#37c3d6")

        }


        //HELP once i have the first help fixed, I can come back and finish this
        function updatemap(incomeKey) {
          if (incomeKey == "All Countries"){
            var updatedData = data
            mortvals = mortvalsorig
          }
          else {
            var updatedData = data.filter((d) => {return d['IncomeGroup'] === incomeKey})
            console.log("hi")
            console.log(updatedData)
            let mortvals = d3.map(updatedData, d => d.maternal_mortality_ratio)
            console.log(mortvals)

          }


          var countriesnew = updatedData
          const colorScalenew = d3.scaleQuantile()
                                  .domain(Object.values(mortvals))
                                  .range(["#f9f4f4","#eda4a4","#da6a6a","#9a2809"]);
          console.log(countries)

          bottomAxis.scale(countryScale)
          bottomAxisG.call(bottomAxis);

          map.selectAll("path.countries").data(countries.features)
                                              .join("path")
                                              .attr("class", "country")
                                              .attr("note", d=>d.id)
                                              .attr("d", path)
                                              .on("click", clicked)
                                              .style("fill", d=>colorScale(mortvals[d.properties.name]))

      };

      updateBars("All Countries");











  };
  requestData();

  </script>








</body>
</html>
